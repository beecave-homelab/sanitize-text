<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyScrub WebUI</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <header>
            <h1>Sanitize Text - WebUI</h1>
            <p>Anonymize Personal Identifiable Information in your text</p>
        </header>
        
        <main>
            <div class="text-area-container">
                <label for="input-text">Input Text</label>
                <textarea 
                    id="input-text" 
                    placeholder="Enter text containing PII here..."
                    spellcheck="true"
                ></textarea>

                <div class="upload-container">
                    <label for="upload-file">Or upload a file to scrub:</label>
                    <input id="upload-file" type="file" accept=".txt,.pdf,.doc,.docx,.rtf,.png,.jpg,.jpeg,.tif,.tiff,.bmp,.webp" />
                </div>

                <div class="button-row">
                    <button id="process-btn" class="primary">Process Text</button>
                    <button id="process-file-btn">Process Uploaded File</button>
                    <button id="download-text-btn">Download From Text</button>
                    <button id="download-file-btn">Download From File</button>
                </div>
            </div>

            <div class="controls-container">
                <div class="locale-selector">
                    <label for="locale">Language:</label>
                    <select id="locale">
                        <option value="">Both (NL + EN)</option>
                        <option value="nl_NL">Dutch (NL)</option>
                        <option value="en_US">English (EN)</option>
                    </select>
                </div>

                <div class="detector-options">
                    <div class="detector-group">
                        <h3>Universal Detectors</h3>
                        <div class="detector-list">
                            {% for key, description in generic_detectors.items() %}
                                <label title="{{ description }}">
                                    <input type="checkbox" name="detector" value="{{ key }}" checked>
                                    {{ key.replace('_', ' ').title() }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="detector-group" id="en-detectors">
                        <h3>English Detectors</h3>
                        <div class="detector-list">
                            {% for key, description in english_detectors.items() %}
                                <label title="{{ description }}">
                                    <input type="checkbox" name="detector" value="en:{{ key }}" {% if key != 'date_of_birth' %}checked{% endif %}>
                                    {{ key.replace('_', ' ').title() }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>

                    <div class="detector-group" id="nl-detectors">
                        <h3>Dutch Detectors</h3>
                        <div class="detector-list">
                            {% for key, description in dutch_detectors.items() %}
                                <label title="{{ description }}">
                                    <input type="checkbox" name="detector" value="nl:{{ key }}" checked>
                                    {{ key.replace('_', ' ').title() }}
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                    {% if not spacy_available %}
                        <p class="detector-note">Install <code>sanitize-text[spacy]</code> to enable optional spaCy-powered entity detectors.</p>
                    {% endif %}
                </div>

                <div class="extra-options">
                    <div class="field">
                        <label for="custom-text">Custom text to detect (optional):</label>
                        <input id="custom-text" type="text" placeholder="e.g. AcmeCorp or Employee ID 1234" />
                    </div>
                    <div class="field-row">
                        <label class="toggle">
                            <input id="cleanup" type="checkbox" checked />
                            Cleanup output
                        </label>
                        <label class="toggle">
                            <input id="verbose" type="checkbox" />
                            Show verbose PII mappings
                        </label>
                    </div>
                    <div class="field-row">
                        <label for="output-format">Output format:</label>
                        <select id="output-format">
                            <option value="txt" selected>TXT</option>
                            <option value="docx">DOCX</option>
                            <option value="pdf">PDF</option>
                        </select>

                        <label for="pdf-mode">PDF mode:</label>
                        <select id="pdf-mode">
                            <option value="pre" selected>Preformatted</option>
                            <option value="para">Paragraph</option>
                        </select>

                        <label for="font-size">Font size:</label>
                        <input id="font-size" type="number" min="6" max="48" value="11" />
                    </div>
                </div>
            </div>

            <div class="text-area-container">
                <label for="output-text">Processed Text</label>
                <textarea 
                    id="output-text" 
                    readonly 
                    placeholder="Processed text will appear here..."
                ></textarea>
                <div id="verbose-output" style="display:none; white-space: pre-wrap; font-family: monospace; font-size: 0.9rem; margin-top: 0.5rem;"></div>
                <button id="copy-btn" class="secondary">
                    Copy to Clipboard
                </button>
            </div>
        </main>
    </div>

    <script>
        const localeSelect = document.getElementById('locale');
        const enDetectors = document.getElementById('en-detectors');
        const nlDetectors = document.getElementById('nl-detectors');

        function updateDetectorVisibility() {
            const locale = localeSelect.value;
            if (locale === 'en_US') {
                enDetectors.style.display = 'block';
                nlDetectors.style.display = 'none';
            } else if (locale === 'nl_NL') {
                enDetectors.style.display = 'none';
                nlDetectors.style.display = 'block';
            } else {
                enDetectors.style.display = 'block';
                nlDetectors.style.display = 'block';
            }
        }

        localeSelect.addEventListener('change', updateDetectorVisibility);
        updateDetectorVisibility();

        function getSelectedDetectors() {
            return Array.from(document.querySelectorAll('input[name="detector"]:checked'))
                .map(cb => cb.value);
        }

        function renderResultsIntoOutput(data) {
            const outputText = document.getElementById('output-text');
            const verboseDiv = document.getElementById('verbose-output');
            if (data.results) {
                const formattedText = data.results
                    .map(result => `[${result.locale}]\n${result.text}`)
                    .join('\n\n');
                outputText.value = formattedText;

                const verboseOn = document.getElementById('verbose').checked;
                if (verboseOn) {
                    const parts = data.results.map(r => {
                        if (!r.filth) return `[${r.locale}]\n(no filth details)`;
                        const lines = r.filth.map(f => `- ${f.type}: '${f.text}' -> '${f.replacement}'`);
                        return `[${r.locale}]\n` + lines.join('\n');
                    });
                    verboseDiv.style.display = 'block';
                    verboseDiv.textContent = parts.join('\n\n');
                } else {
                    verboseDiv.style.display = 'none';
                    verboseDiv.textContent = '';
                }
            } else {
                outputText.value = 'No results returned';
                verboseDiv.style.display = 'none';
                verboseDiv.textContent = '';
            }
        }

        document.getElementById('process-btn').addEventListener('click', async () => {
            const inputText = document.getElementById('input-text').value;
            const locale = document.getElementById('locale').value;
            const processBtn = document.getElementById('process-btn');
            const outputText = document.getElementById('output-text');
            const custom = document.getElementById('custom-text').value || null;
            const cleanup = document.getElementById('cleanup').checked;
            const verbose = document.getElementById('verbose').checked;
            const selectedDetectors = getSelectedDetectors();
            
            try {
                processBtn.disabled = true;
                processBtn.textContent = 'Processing...';
                outputText.value = '';
                
                const response = await fetch('/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        text: inputText,
                        locale: locale || null,
                        detectors: selectedDetectors,
                        custom,
                        cleanup,
                        verbose
                    }),
                });
                
                const data = await response.json();
                if (response.ok) {
                    renderResultsIntoOutput(data);
                } else {
                    alert(data.error || 'Error processing text');
                }
            } catch (error) {
                alert('Error processing text. Please try again.');
            } finally {
                processBtn.disabled = false;
                processBtn.textContent = 'Process Text';
            }
        });

        document.getElementById('process-file-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('upload-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to process.');
                return;
            }
            const locale = document.getElementById('locale').value;
            const custom = document.getElementById('custom-text').value || '';
            const cleanup = document.getElementById('cleanup').checked;
            const verbose = document.getElementById('verbose').checked;
            const selectedDetectors = getSelectedDetectors();

            const form = new FormData();
            form.append('file', fileInput.files[0]);
            if (locale) form.append('locale', locale);
            if (custom) form.append('custom', custom);
            form.append('cleanup', cleanup ? 'true' : 'false');
            form.append('verbose', verbose ? 'true' : 'false');
            selectedDetectors.forEach(d => form.append('detectors', d));

            try {
                const btn = document.getElementById('process-file-btn');
                btn.disabled = true;
                btn.textContent = 'Processing File...';
                const resp = await fetch('/process-file', { method: 'POST', body: form });
                const data = await resp.json();
                if (resp.ok) {
                    renderResultsIntoOutput(data);
                } else {
                    alert(data.error || 'Error processing file');
                }
            } catch (e) {
                alert('Error processing file. Please try again.');
            } finally {
                const btn = document.getElementById('process-file-btn');
                btn.disabled = false;
                btn.textContent = 'Process Uploaded File';
            }
        });

        async function triggerDownloadFromResponse(resp, fallbackName) {
            const blob = await resp.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            const cd = resp.headers.get('Content-Disposition') || '';
            const match = /filename\*=UTF-8''([^;]+)|filename="?([^";]+)"?/i.exec(cd);
            const headerName = match ? decodeURIComponent(match[1] || match[2]) : fallbackName;
            a.href = url;
            a.download = headerName || fallbackName;
            document.body.appendChild(a);
            a.click();
            a.remove();
            window.URL.revokeObjectURL(url);
        }

        document.getElementById('download-text-btn').addEventListener('click', async () => {
            const inputText = document.getElementById('input-text').value;
            if (!inputText) { alert('Please enter input text first.'); return; }
            const locale = document.getElementById('locale').value;
            const custom = document.getElementById('custom-text').value || null;
            const cleanup = document.getElementById('cleanup').checked;
            const outputFormat = document.getElementById('output-format').value;
            const pdfMode = document.getElementById('pdf-mode').value;
            const fontSize = parseInt(document.getElementById('font-size').value || '11', 10);
            const detectors = getSelectedDetectors();

            try {
                const btn = document.getElementById('download-text-btn');
                btn.disabled = true;
                btn.textContent = 'Preparing Download...';
                const resp = await fetch('/export', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: inputText,
                        locale: locale || null,
                        detectors,
                        custom,
                        cleanup,
                        output_format: outputFormat,
                        pdf_mode: pdfMode,
                        font_size: fontSize,
                    }),
                });
                if (!resp.ok) {
                    let err = 'Download failed';
                    try { const j = await resp.json(); err = j.error || err; } catch {}
                    alert(err); return;
                }
                await triggerDownloadFromResponse(resp, `scrubbed.${outputFormat}`);
            } catch (e) {
                alert('Failed to prepare download.');
            } finally {
                const btn = document.getElementById('download-text-btn');
                btn.disabled = false;
                btn.textContent = 'Download From Text';
            }
        });

        document.getElementById('download-file-btn').addEventListener('click', async () => {
            const fileInput = document.getElementById('upload-file');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select a file to download results for.');
                return;
            }
            const locale = document.getElementById('locale').value;
            const custom = document.getElementById('custom-text').value || '';
            const cleanup = document.getElementById('cleanup').checked;
            const outputFormat = document.getElementById('output-format').value;
            const pdfMode = document.getElementById('pdf-mode').value;
            const fontSize = document.getElementById('font-size').value || '11';
            const detectors = getSelectedDetectors();

            const form = new FormData();
            form.append('file', fileInput.files[0]);
            if (locale) form.append('locale', locale);
            if (custom) form.append('custom', custom);
            form.append('cleanup', cleanup ? 'true' : 'false');
            form.append('output_format', outputFormat);
            form.append('pdf_mode', pdfMode);
            form.append('font_size', String(fontSize));
            detectors.forEach(d => form.append('detectors', d));

            try {
                const btn = document.getElementById('download-file-btn');
                btn.disabled = true;
                btn.textContent = 'Preparing Download...';
                const resp = await fetch('/download-file', { method: 'POST', body: form });
                if (!resp.ok) {
                    let err = 'Download failed';
                    try { const j = await resp.json(); err = j.error || err; } catch {}
                    alert(err); return;
                }
                await triggerDownloadFromResponse(resp, `scrubbed.${outputFormat}`);
            } catch (e) {
                alert('Failed to prepare download.');
            } finally {
                const btn = document.getElementById('download-file-btn');
                btn.disabled = false;
                btn.textContent = 'Download From File';
            }
        });

        document.getElementById('copy-btn').addEventListener('click', () => {
            const outputText = document.getElementById('output-text');
            outputText.select();
            document.execCommand('copy');
            
            const copyBtn = document.getElementById('copy-btn');
            const originalText = copyBtn.textContent;
            copyBtn.textContent = 'Copied!';
            
            setTimeout(() => {
                copyBtn.textContent = originalText;
            }, 2000);
        });
    </script>

    <style>
        .controls-container {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin: 1rem 0;
        }

        .locale-selector {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .locale-selector select {
            padding: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1rem;
        }

        .locale-selector label {
            font-weight: bold;
        }

        .detector-options {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            padding: 1rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            background-color: #f9f9f9;
        }

        .detector-note {
            width: 100%;
            margin: 0;
            font-size: 0.9rem;
            color: #555;
        }

        .detector-group {
            min-width: 200px;
        }

        .detector-group h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1rem;
            color: #333;
        }

        .detector-list {
            display: flex;
            flex-direction: column;
            gap: 0.3rem;
        }

        .detector-list label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .detector-list input[type="checkbox"] {
            margin: 0;
        }

        .extra-options { display: flex; flex-direction: column; gap: 0.75rem; }
        .field { display: flex; flex-direction: column; gap: 0.25rem; }
        .field-row { display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; }
        .field-row select, .field-row input[type="number"], .extra-options input[type="text"] {
            padding: 0.5rem; border: 1px solid #ccc; border-radius: 4px; font-size: 1rem;
        }
        .toggle { display: inline-flex; align-items: center; gap: 0.5rem; }
        .upload-container { display: flex; flex-direction: column; gap: 0.25rem; }
        .button-row { display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: flex-end; }
        #process-btn {
            align-self: flex-end;
        }
    </style>
</body>
</html>